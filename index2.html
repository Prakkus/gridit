<!DOCTYPE html>
<html>
<head>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Manrope&display=swap" rel="stylesheet"> 
<title>Gridit</title>
	<style>
	:root {
		--light: #52525B;
		--dark: #3F3F46;
		--darker: #27272A;
		--darkest: #18181B;
		--text-default: rgba(255, 255, 255, 0.87);
	}

	* {
        font-family: 'Manrope', sans-serif;
        margin: 0;
		outline: 0;
		border: none;
	}

	input::-webkit-outer-spin-button,
	input::-webkit-inner-spin-button {
	  -webkit-appearance: none;
	  margin: 0;
	}

	/* Firefox */
	input[type=number] {
	  -moz-appearance: textfield;
	}

	html {
		background: var(--darkest);
	}

	button, input {
		color: var(--text-default);
		border: 1px solid var(--light);
		background: var(--dark);
		padding: 8px 5px;
	}

	input:focus {
		background-color: var(--light);		
	}

	button:hover {
		background-color: var(--light);		
	}


	.control-panel {
		color: var(--text-default);
		position: fixed;
		right: 0px;
		background: var(--darker);
		padding: 12px;
		width: 371px;
		display: flex;
		flex-direction: column;
		max-height: 100vh;
		overflow-y: auto;
		box-sizing: border-box; /* specfically so that the scroll bar doesn't mess with the inner width */
	}

	.control-panel > * {
		margin-bottom: 12px;
	}

	.control-panel .action-list > button {
		width: 100%;
		margin-bottom: 12px;
	}

	#grid-mount-point {
		display: grid;
  	}


  	.grid-coords-hidden .grid-coords-display {
  		display: none;
  	}

	</style>
</head>
<body>

<div class="grid-container">
	<div id="control-panel-mount-point"  class="control-panel">
	</div>
	<div id="grid-mount-point">
	</div>
</div>
	<script type="module">
		import initStore from './src/data/store.js'
		import profile from './src/config/default-save.js';
		import PersistenceView from './src/components/PersistenceView.js'
		import GridConfigView from './src/components/GridConfigView.js';
		import GridView from './src/components/GridView.js'
		import SchemaControls from './src/components/SchemaControls.js';
		import { openFileSelectionWindow } from './src/data/Persistence.js';
		import GridDrag from './src/components/GridDrag.js';
		import { 
			loadGridJsonData, UpdateGridDisplayOptions, UpdateGridSize, UpdateCells,
			SelectCurrentlySelectedAttributeUpdate, SelectCellById, SelectDefaultCellAttributes, SelectAllCellData, SelectGridSize, SelectGridDisplayOptions, 
			SelectLoadedJsonData, SelectLoadedSchemas, SetSelectedSchemaValue, SelectSchemaValue, SelectCurrentlySelectedSchemaValue } from './src/data/store.js';


		const Main = () => {
			console.log(SelectCellById);
			// Grab references to the parts of the page that we're going to mount elements to.
			const controlPanelMountElement = document.getElementById("control-panel-mount-point");
			const styleMountElement = document.createElement('style');
			const gridMountElement = document.querySelector("#grid-mount-point");
			// Helpers for adding style and elements to the page.
			const InjectStyle = (styles) => styleMountElement.insertAdjacentHTML('beforeend', styles);
			const MountElement = (parent, elementToMount) => parent.insertAdjacentElement('beforeend', elementToMount);	
			// Create the store which will contain all of our app state.
			const { UseSelector, store } = initStore();

			
			// Now let's start adding our components to the page.
			// Initialize the GridView.
			const { element: gridElement, defaultStyle: gridViewStyles, RenderGridAndCells, RenderCell } = 
			GridView(
				(schemaIndex, valueIndex) => UseSelector(state => SelectSchemaValue(state, {schemaIndex, valueIndex}))
			);
			// Update a set of cells with a given set of attributes and then rerender them individually.
			const UpdateAndRenderCells = (cellIds, attributeUpdates) => {
				UpdateCells(store, { cellIds, attributeUpdates});
				cellIds.forEach((cellId) => {
					const { attributes } = UseSelector(state => SelectCellById(state, { cellId }));
					RenderCell(cellId, attributes);
				});
			}
			const HandleCellUpdate = (cellId) => {
				console.log(`${cellId} clicked!`);
				const attributeUpdate = UseSelector(SelectCurrentlySelectedAttributeUpdate);
				console.log(attributeUpdate);
				UpdateAndRenderCells([cellId], attributeUpdate)
			}
			const { BindDragEvents } = GridDrag(HandleCellUpdate);
			BindDragEvents(window);



			// Update the size and display options for a grid and rerenders it with the currently loaded cell data.
			const RefreshGrid = () => {
				const gridSize = UseSelector(SelectGridSize);
				const gridDisplayOptions = UseSelector(SelectGridDisplayOptions);
				const cellData = UseSelector(SelectAllCellData);
				const defaultCellAttributes = UseSelector(SelectDefaultCellAttributes);

				// Update the view to match the new data. 
				// Todo: this should be an Effect and be event driven.
				RenderGridAndCells(gridSize.x, gridSize.y, gridDisplayOptions.cellSize, gridDisplayOptions.cellGap, gridDisplayOptions.showCoords, cellData, defaultCellAttributes);
			}

			// Handle a json file for import being selected in the PersistenceView.
			const handleFileSelect = (event) => {
				let file = event.target.files[0];
				if (!file.type.match('^application/json')) return;
				file.text().then(value => {
					// Loads the json and imports the data.
					loadGridJsonData(store, {jsonText: value});
					RefreshGridConfig();
					RefreshGrid();
				});
			}

			MountElement(gridMountElement, gridElement);
			InjectStyle(gridViewStyles);
			

			// Initialize the Persistence View. 
			const {defaultStyle: persistenceStyle, element: persistenceElement} = PersistenceView( 
				{ openFileImportWindow: () => openFileSelectionWindow(handleFileSelect) } 
			);
			MountElement(controlPanelMountElement, persistenceElement);
			InjectStyle(persistenceStyle);

			// Update the store value and re-render the panel.
			const OnSubmit = (data) => {
				UpdateGridSize(store, { width: data.columnCount, height: data.rowCount });
				UpdateGridDisplayOptions(store, { cellSize: data.cellSize, cellGap: data.cellGap, showCoords: data.showCoords });
				RefreshGridConfig();
				RefreshGrid();
			}
			const {defaultStyle: gridConfigStyle, GridConfigElement, render: renderGridConfig} = GridConfigView(OnSubmit);
			MountElement(controlPanelMountElement, GridConfigElement);
			InjectStyle(gridConfigStyle);
			const RefreshGridConfig = () => {
				const gridSize = UseSelector(SelectGridSize);
				const gridDisplayOptions = UseSelector(SelectGridDisplayOptions);
				renderGridConfig({ columnCount: gridSize.x, rowCount: gridSize.y, ...gridDisplayOptions });
			}

			// SchemaControls
			const OnSchemaSelection = (schemaIndex, valueIndex) => {
				SetSelectedSchemaValue(store, { schemaIndex, valueIndex });
				RefreshSchemaControls();
			}
			const { SchemaControlsElement, defaultStyle: schemaStyle, Render: RenderSchemaControls } = SchemaControls(OnSchemaSelection, UseSelector);
			const RefreshSchemaControls = () => {
				const loadedSchemas = UseSelector(SelectLoadedSchemas);
				const selectedSchemaValue = UseSelector(SelectCurrentlySelectedSchemaValue);
				RenderSchemaControls({loadedSchemas, ...selectedSchemaValue });
			}
			MountElement(controlPanelMountElement, SchemaControlsElement);
			InjectStyle(schemaStyle);

			// Load the default grid profile. This contains default schema information.
			loadGridJsonData(store, {jsonText: JSON.stringify(profile)});
			// Build the grid now that the profile is loaded.
			RefreshGrid();
			// Render grid config
			RefreshGridConfig();
			RefreshSchemaControls();



			document.head.insertAdjacentElement('beforeend', styleMountElement);
		};


		document.addEventListener('DOMContentLoaded', Main);

	</script>
</body>
</html>