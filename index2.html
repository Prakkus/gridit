<!DOCTYPE html>
<html>
<head>
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link href="./style.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Manrope&display=swap" rel="stylesheet"> 
	<title>Gridit</title>
</head>
<body>
	<div class="grid-container">
		<div id="control-panel-mount-point"  class="control-panel">
		</div>
		<div id="grid-mount-point">
		</div>
	</div>
	<script type="module">
		import { InjectStyles, MountElement } from './src/DOMUtils.js';
		import { store, Connect, UseSelector, ApplyMutation } from './src/data/AppState.js'
		import defaultSaveFile from './src/config/default-save.js';
		import GridDrag from './src/components/GridDrag.js';
		import GridView, { style as gridStyle } from './src/components/GridView.js'
		import TilesetView, { style as tilesetViewStyle } from './src/components/TilesetView.js';
		import ModalView, { style as modalViewStyle } from './src/components/ModalView.js';
		import GridControlPanel, { style as gridControlPanelStyle} from './src/components/GridControlPanel.js';
		import { LoadGridJsonData, SelectCurrentlySelectedAttributeUpdate, LoadValuesIntoSchema, UpdateCells, SelectCellById } from './src/data/AppState.js';

		const Main = () => {
			// Inject the styles for all the loaded components.
			InjectStyles(gridStyle, tilesetViewStyle, modalViewStyle, gridControlPanelStyle);
			// Grab references to the parts of the page that we're going to mount elements to.
			const controlPanelMountElement = document.getElementById("control-panel-mount-point");
			const gridMountElement = document.querySelector("#grid-mount-point");
			
			// Update a set of cells with a given set of attributes and then rerender them individually.
			const UpdateAndRenderCells = (cellIds, attributeUpdates) => {
				ApplyMutation(UpdateCells, { cellIds, attributeUpdates});
				cellIds.forEach((cellId) => {
					const { attributes } = UseSelector(state => SelectCellById(state, { cellId }));
					RenderCell({ cellId, attributes });
				});
			}
			const HandleCellUpdate = (cellId) => {
				const attributeUpdate = UseSelector(SelectCurrentlySelectedAttributeUpdate);
				UpdateAndRenderCells([cellId], attributeUpdate)
			}
			
			const { BindDragEvents } = GridDrag(HandleCellUpdate);
			BindDragEvents(window);

			// Grid View
			const { element: gridElement, RenderCell } = GridView();
			MountElement(gridMountElement, gridElement);

			// Grid Control Panel
			const { element: gridControlPanelElement} = GridControlPanel();
			MountElement(controlPanelMountElement, gridControlPanelElement);	

			// TilesetView
			const { element: tilesetViewElement, Render: RenderTilesetView } = TilesetView();
			RenderTilesetView({
				slicesExtractedHandler: (slices) => {
					// Prepend an empty image cell to act as the default value.
					ApplyMutation(LoadValuesIntoSchema, { schemaIndex: 2, schemaValues: [{ imageDataUrl: '' }, ...slices] });
					CloseTilesetModal();
				} 
			});

			// ModalView
			const { element: modalElement, Render: RenderModal, Open: OpenTilesetModal, Close: CloseTilesetModal } = ModalView();
			MountElement(document.body, modalElement);
			RenderModal({title: 'Import a tileset', content: tilesetViewElement});

			// Load the default grid profile. This contains default schema information.
			ApplyMutation(LoadGridJsonData, {jsonText: JSON.stringify(defaultSaveFile)});
		};


		document.addEventListener('DOMContentLoaded', Main);
	</script>
</body>
</html>